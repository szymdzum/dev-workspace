name: Health Check

on:
  schedule:
    # Runs every 20 seconds (Note: GitHub minimum is actually 1 minute)
    # Using */1 * * * * for every minute as 20 seconds isn't supported
    - cron: '* * * * *'  # Every minute (closest to 20 seconds possible)
  workflow_dispatch:  # Allow manual triggering
  push:
    branches: [main]

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run health checks
        run: |
          echo "üè• Running health checks..."
          
          # Check if build works
          echo "üì¶ Testing build..."
          pnpm nx run-many -t build --parallel=3 --skip-nx-cache
          
          # Check if tests pass
          echo "üß™ Running quick tests..."
          pnpm nx run-many -t test --parallel=3 --skip-nx-cache --passWithNoTests
          
          # Check dependencies
          echo "üîç Checking dependencies..."
          pnpm audit --audit-level=high
          
          # Memory and performance check
          echo "‚ö° Performance check..."
          node -e "
            const used = process.memoryUsage();
            console.log('Memory usage:', {
              rss: Math.round(used.rss / 1024 / 1024) + 'MB',
              heapUsed: Math.round(used.heapUsed / 1024 / 1024) + 'MB'
            });
          "
          
          echo "‚úÖ All health checks passed!"
      
      - name: Report status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ System healthy - all checks passed"
          else
            echo "‚ùå System unhealthy - checks failed"
            exit 1
          fi